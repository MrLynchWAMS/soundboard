<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customizable Soundboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Compression library for URL sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root {
            --background-color: #111827; /* gray-900 */
            --surface-color: #1f2937;    /* gray-800 */
            --primary-color: #3b82f6;   /* blue-500 */
            --primary-hover: #2563eb;   /* blue-600 */
            --text-primary: #f9fafb;     /* gray-50 */
            --text-secondary: #9ca3af;   /* gray-400 */
            --border-color: #374151;     /* gray-700 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sound-btn {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .sound-btn:hover {
            transform: translateY(-2px);
            border-color: #4b5563; /* gray-600 */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .sound-btn:active {
            transform: scale(0.98);
        }
        .draggable { cursor: move; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .drag-over {
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }
        .edit-mode .sound-btn .edit-overlay {
            display: flex;
        }
        .modal, .notification-toast {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--text-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #soundboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        #library-sound-list { max-height: 400px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-screen-2xl">

        <!-- Header -->
        <header class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-4 mb-6 sticky top-4 z-20 border border-gray-700/50">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <i class="fas fa-compact-disc text-blue-400"></i> My Soundboard
                </h1>
                <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-3">
                    <div class="relative w-full sm:w-64">
                        <input type="text" id="searchInput" placeholder="Search sounds..." class="w-full bg-gray-900/50 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>
                     <label for="editModeToggle" class="flex items-center cursor-pointer select-none p-2 rounded-lg hover:bg-gray-700">
                        <span class="mr-3 text-sm font-medium">Edit Mode</span>
                        <div class="relative">
                            <input type="checkbox" id="editModeToggle" class="sr-only peer">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full peer-checked:bg-blue-600 transition"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform peer-checked:translate-x-6"></div>
                        </div>
                    </label>
                </div>
            </div>
             <div id="edit-actions" class="hidden flex-wrap items-center justify-center sm:justify-start gap-4 mt-4 pt-4 border-t border-gray-700">
                <button id="addSectionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> Add Section</button>
                <button id="libraryBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-book"></i> Sound Library</button>
                <button id="aiCreateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm">✨ Create with AI</button>
                <button id="shareBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-share-alt"></i> Share</button>
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-file-export"></i> Export</button>
                <button onclick="document.getElementById('importInput').click()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-file-import"></i> Import</button>
                <input type="file" id="importInput" class="hidden" accept=".json">
                 <div class="flex items-center gap-3 text-sm ml-auto">
                    <label for="gridSizeSlider" class="font-medium">Button Size</label>
                    <input type="range" id="gridSizeSlider" min="4" max="12" value="8" class="w-32 cursor-pointer">
                </div>
            </div>
        </header>

        <!-- Soundboard Grid -->
        <main id="soundboard-grid">
            <!-- Sections will be dynamically inserted here -->
        </main>
        
        <div id="empty-state" class="hidden text-center p-10 bg-gray-800 rounded-lg border-2 border-dashed border-gray-700">
            <h2 class="text-2xl font-bold mb-2">Welcome to your soundboard!</h2>
            <p class="text-gray-400 mb-4">It's empty here. Turn on "Edit Mode" to add sections and sounds.</p>
            <i class="fas fa-hand-pointer fa-2x text-blue-400 animate-bounce"></i>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-md m-4 border border-border-color modal">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Modal Title</h2>
            <form id="modalForm" novalidate>
                <input type="hidden" id="editId"><input type="hidden" id="editType"><input type="hidden" id="editSectionId">
                <div id="form-group-name" class="mb-4">
                    <label for="itemName" class="block text-sm font-medium text-text-secondary mb-1">Name</label>
                    <input type="text" id="itemName" class="w-full bg-gray-900/50 border border-border-color text-text-primary rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-color">
                </div>
                <div id="form-group-url" class="mb-4">
                    <label for="itemUrl" class="block text-sm font-medium text-text-secondary mb-1">Audio URL</label>
                    <input type="text" id="itemUrl" class="w-full bg-gray-900/50 border border-border-color text-text-primary rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-color" placeholder="https://example.com/sound.mp3">
                </div>
                 <div id="form-group-width" class="mb-4">
                    <label for="itemWidth" class="block text-sm font-medium text-text-secondary mb-1">Section Width</label>
                    <input type="range" id="itemWidth" min="1" max="4" value="4" class="w-full">
                </div>
                <div id="form-group-color" class="mb-4">
                    <label for="itemColor" class="block text-sm font-medium text-text-secondary mb-1">Button Color</label>
                    <input type="color" id="itemColor" class="w-full h-10 bg-transparent rounded-lg p-0 border-0 cursor-pointer" value="#374151">
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" id="cancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-primary-color hover:bg-primary-hover text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="libraryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-lg m-4 border border-border-color modal">
            <h2 class="text-2xl font-bold mb-4">Sound Library</h2>
            <p class="text-text-secondary mb-4 text-sm">Sounds from your GitHub repository. Select sounds to add them to a new section.</p>
            <div id="library-sound-list" class="overflow-y-auto bg-gray-900/50 rounded-lg p-2 border border-border-color space-y-1">
                <!-- Library sounds will be populated here -->
            </div>
            <div class="flex justify-between items-center mt-6">
                 <button id="librarySelectAll" class="text-sm text-blue-400 hover:underline">Select All</button>
                <div>
                    <button id="libraryCancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Close</button>
                    <button id="libraryAddBtn" class="bg-primary-color hover:bg-primary-hover text-white font-bold py-2 px-4 rounded-lg">Add Selected</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-md m-4 border border-border-color modal">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">✨ Create with AI</h2>
            <p class="text-text-secondary mb-4 text-sm">Enter a theme, and Gemini will generate a new section with sound ideas.</p>
            <form id="aiModalForm"><!-- ... --></form>
        </div>
    </div>
    
    <div id="shareModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-lg m-4 border border-border-color modal"><!-- ... --></div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-sm m-4 border border-border-color modal"><!-- ... --></div>
    </div>

    <div id="notification-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Declarations ---
        const soundboardGrid = document.getElementById('soundboard-grid');
        const searchInput = document.getElementById('searchInput');
        const editModeToggle = document.getElementById('editModeToggle');
        const gridSizeSlider = document.getElementById('gridSizeSlider');
        
        // Modals & Forms
        const modal = document.getElementById('modal');
        const modalForm = document.getElementById('modalForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmModal = document.getElementById('confirmModal');
        const aiModal = document.getElementById('aiModal');
        const shareModal = document.getElementById('shareModal');
        const libraryModal = document.getElementById('libraryModal');
        const librarySoundList = document.getElementById('library-sound-list');
        
        // Buttons
        const addSectionBtn = document.getElementById('addSectionBtn');
        const libraryBtn = document.getElementById('libraryBtn');
        const aiCreateBtn = document.getElementById('aiCreateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importInput = document.getElementById('importInput');
        const shareBtn = document.getElementById('shareBtn');
        const libraryCancelBtn = document.getElementById('libraryCancelBtn');
        const libraryAddBtn = document.getElementById('libraryAddBtn');
        const librarySelectAll = document.getElementById('librarySelectAll');
        
        // --- State ---
        let audioContext = null;
        let currentAudioSource = null;
        let soundData = [];
        let confirmCallback = null;
        let draggedItem = null;

        const initialData = []; // Start with an empty soundboard

        // --- Core Functions ---
        const loadData = () => {
            try {
                if (window.location.hash && window.location.hash.startsWith('#data=')) {
                    // ... (load from URL logic)
                } else {
                    const savedData = localStorage.getItem('soundboardData');
                    soundData = savedData ? JSON.parse(savedData) : initialData;
                }
            } catch (error) {
                // ... (error handling)
                soundData = initialData;
            }
            const savedGridSize = localStorage.getItem('soundboardButtonGridSize') || '8';
            gridSizeSlider.value = savedGridSize;
            renderSoundboard();
        };

        const saveData = () => {
             localStorage.setItem('soundboardData', JSON.stringify(soundData));
            if (window.location.hash) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        };
        const saveGridSize = () => localStorage.setItem('soundboardButtonGridSize', gridSizeSlider.value);

        function playSound(url, button = null) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            if (currentAudioSource) try { currentAudioSource.stop(); } catch (e) {}

            const originalIcon = button ? button.innerHTML : null;
            if(button) button.innerHTML = '<div class="spinner !w-5 !h-5"></div>';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    currentAudioSource = source;
                    source.onended = () => { if(button) button.innerHTML = originalIcon; };
                }).catch(e => {
                    let userMessage = `Error playing sound: ${e.message}`;
                    if (e instanceof TypeError) userMessage = 'Could not play sound. The audio host may be blocking it (CORS policy).';
                    showNotification(userMessage, 'error');
                    console.error('Error with audio playback:', e);
                    if(button) button.innerHTML = originalIcon;
                });
        }
        
        function showNotification(message, type = 'info') {
            // ... (notification logic)
        }

        // --- Rendering ---
        
        function renderSoundboard(filteredData = null) {
            // ... (render logic remains the same)
        }

        function createSoundButton(sound, sectionId) {
            // ... (create button logic remains the same)
        }

        // --- Event Handlers ---
        soundboardGrid.addEventListener('click', (e) => {
            // ... (existing click logic)
            // Modified else block for non-edit mode
            const soundBtn = e.target.closest('.sound-btn');
            if (!document.body.classList.contains('edit-mode') && soundBtn) {
                 playSound(soundBtn.dataset.url, soundBtn.querySelector('i'));
            }
        });
        
        // ... (other event handlers remain mostly the same)

        // --- Modal Logic ---
        function openModal(type, mode, data) {
            // ... (existing modal logic)
        }

        function closeModal() {
            modal.classList.add('hidden');
            aiModal.classList.add('hidden');
            confirmModal.classList.add('hidden');
            shareModal.classList.add('hidden');
            libraryModal.classList.add('hidden');
        }

        modalForm.addEventListener('submit', (e) => {
            // ... (existing form submit logic)
        });

        [cancelBtn, libraryCancelBtn].forEach(btn => btn.addEventListener('click', closeModal));
        addSectionBtn.addEventListener('click', () => openModal('section', 'add', {}));
        
        // --- Sound Library Logic ---
        libraryBtn.addEventListener('click', async () => {
            libraryModal.classList.remove('hidden');
            librarySoundList.innerHTML = '<div class="flex justify-center items-center p-8"><div class="spinner !w-8 !h-8"></div></div>';
            
            try {
                const response = await fetch('https://api.github.com/repos/MrLynchWAMS/soundboard/contents/sounds');
                if (!response.ok) throw new Error('Failed to fetch from GitHub');
                const files = await response.json();
                
                librarySoundList.innerHTML = '';
                const audioFiles = files.filter(file => /\.(mp3|wav|ogg)$/i.test(file.name));

                if (audioFiles.length === 0) {
                    librarySoundList.innerHTML = '<p class="text-center text-gray-500 p-4">No audio files found in the GitHub repository.</p>';
                    return;
                }

                audioFiles.forEach(file => {
                    const soundEl = document.createElement('div');
                    soundEl.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-700';
                    soundEl.innerHTML = `
                        <label class="flex items-center gap-3 cursor-pointer w-full">
                            <input type="checkbox" data-name="${file.name}" data-url="${file.download_url}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 rounded text-blue-500 focus:ring-blue-500">
                            <span class="truncate">${file.name}</span>
                        </label>
                        <button class="preview-lib-sound-btn p-2 text-gray-400 hover:text-white" data-url="${file.download_url}">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                    librarySoundList.appendChild(soundEl);
                });
            } catch (error) {
                console.error("Error fetching sound library:", error);
                librarySoundList.innerHTML = '<p class="text-center text-red-400 p-4">Could not load library. Check console for details.</p>';
            }
        });

        librarySoundList.addEventListener('click', e => {
            const previewBtn = e.target.closest('.preview-lib-sound-btn');
            if (previewBtn) {
                playSound(previewBtn.dataset.url, previewBtn);
            }
        });
        
        librarySelectAll.addEventListener('click', () => {
            const checkboxes = librarySoundList.querySelectorAll('input[type="checkbox"]');
            const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !isAllChecked);
            librarySelectAll.textContent = isAllChecked ? 'Select All' : 'Deselect All';
        });

        libraryAddBtn.addEventListener('click', () => {
            const selectedSounds = Array.from(librarySoundList.querySelectorAll('input[type="checkbox"]:checked'));
            if (selectedSounds.length === 0) {
                showNotification('No sounds selected.', 'error');
                return;
            }

            const newSection = {
                id: `section-${Date.now()}`,
                title: 'From Library',
                width: 4,
                sounds: selectedSounds.map((input, i) => ({
                    id: `sound-${Date.now() + i}`,
                    name: input.dataset.name.replace(/\.[^/.]+$/, ""), // Remove file extension for name
                    url: input.dataset.url,
                    color: '#1f2937'
                }))
            };

            soundData.push(newSection);
            saveData();
            renderSoundboard();
            closeModal();
            showNotification(`Added ${selectedSounds.length} sounds.`, 'info');
        });


        // --- Initialize ---
        loadData();
    });
    </script>
</body>
</html>

