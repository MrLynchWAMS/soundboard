<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customizable Soundboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Compression library for URL sharing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root {
            --background-color: #111827; /* gray-900 */
            --surface-color: #1f2937;    /* gray-800 */
            --primary-color: #3b82f6;   /* blue-500 */
            --primary-hover: #2563eb;   /* blue-600 */
            --text-primary: #f9fafb;     /* gray-50 */
            --text-secondary: #9ca3af;   /* gray-400 */
            --border-color: #374151;     /* gray-700 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sound-btn {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .sound-btn:hover {
            transform: translateY(-2px);
            border-color: #4b5563; /* gray-600 */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }
        .sound-btn:active {
            transform: scale(0.98);
        }
        .draggable { cursor: move; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .drag-over {
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }
        .edit-mode .sound-btn .edit-overlay {
            display: flex;
        }
        .modal, .notification-toast {
            animation: fadeIn 0.3s ease-out;
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid var(--text-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #soundboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        #library-sound-list { max-height: 400px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-screen-2xl">

        <!-- Header -->
        <header class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-4 mb-6 sticky top-4 z-20 border border-gray-700/50">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                    <i class="fas fa-compact-disc text-blue-400"></i> My Soundboard
                </h1>
                <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-3">
                    <div class="relative w-full sm:w-64">
                        <input type="text" id="searchInput" placeholder="Search sounds..." class="w-full bg-gray-900/50 text-white rounded-lg px-4 py-2 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>
                     <label for="editModeToggle" class="flex items-center cursor-pointer select-none p-2 rounded-lg hover:bg-gray-700">
                        <span class="mr-3 text-sm font-medium">Edit Mode</span>
                        <div class="relative">
                            <input type="checkbox" id="editModeToggle" class="sr-only peer">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full peer-checked:bg-blue-600 transition"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform transform peer-checked:translate-x-6"></div>
                        </div>
                    </label>
                </div>
            </div>
             <div id="edit-actions" class="hidden flex-wrap items-center justify-center sm:justify-start gap-4 mt-4 pt-4 border-t border-gray-700">
                <button id="addSectionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> Add Section</button>
                <button id="libraryBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-book"></i> Sound Library</button>
                <button id="aiCreateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm">âœ¨ Create with AI</button>
                <button id="shareBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-share-alt"></i> Share</button>
                <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-file-export"></i> Export</button>
                <button onclick="document.getElementById('importInput').click()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 text-sm"><i class="fas fa-file-import"></i> Import</button>
                <input type="file" id="importInput" class="hidden" accept=".json">
                 <div class="flex items-center gap-3 text-sm ml-auto">
                    <label for="gridSizeSlider" class="font-medium">Button Size</label>
                    <input type="range" id="gridSizeSlider" min="4" max="12" value="8" class="w-32 cursor-pointer">
                </div>
            </div>
        </header>

        <!-- Soundboard Grid -->
        <main id="soundboard-grid">
            <!-- Sections will be dynamically inserted here -->
        </main>
        
        <div id="empty-state" class="hidden text-center p-10 bg-gray-800 rounded-lg border-2 border-dashed border-gray-700">
            <h2 class="text-2xl font-bold mb-2">Welcome to your soundboard!</h2>
            <p class="text-gray-400 mb-4">It's empty here. Turn on "Edit Mode" to add sections and sounds.</p>
            <i class="fas fa-hand-pointer fa-2x text-blue-400 animate-bounce"></i>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-md m-4 border border-border-color modal">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Modal Title</h2>
            <form id="modalForm" novalidate>
                <input type="hidden" id="editId"><input type="hidden" id="editType"><input type="hidden" id="editSectionId">
                <div id="form-group-name" class="mb-4">
                    <label for="itemName" class="block text-sm font-medium text-text-secondary mb-1">Name</label>
                    <input type="text" id="itemName" class="w-full bg-gray-900/50 border border-border-color text-text-primary rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-color">
                </div>
                <div id="form-group-url" class="mb-4">
                    <label for="itemUrl" class="block text-sm font-medium text-text-secondary mb-1">Audio URL</label>
                    <input type="text" id="itemUrl" class="w-full bg-gray-900/50 border border-border-color text-text-primary rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-color" placeholder="https://example.com/sound.mp3">
                </div>
                 <div id="form-group-width" class="mb-4">
                    <label for="itemWidth" class="block text-sm font-medium text-text-secondary mb-1">Section Width</label>
                    <input type="range" id="itemWidth" min="1" max="4" value="4" class="w-full">
                </div>
                <div id="form-group-color" class="mb-4">
                    <label for="itemColor" class="block text-sm font-medium text-text-secondary mb-1">Button Color</label>
                    <input type="color" id="itemColor" class="w-full h-10 bg-transparent rounded-lg p-0 border-0 cursor-pointer" value="#374151">
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" id="cancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-primary-color hover:bg-primary-hover text-white font-bold py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="libraryModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-lg m-4 border border-border-color modal">
            <h2 class="text-2xl font-bold mb-4">Sound Library</h2>
            <p class="text-text-secondary mb-4 text-sm">Sounds from your GitHub repository. Select sounds to add them to a new section.</p>
            <div id="library-sound-list" class="overflow-y-auto bg-gray-900/50 rounded-lg p-2 border border-border-color space-y-1">
                <!-- Library sounds will be populated here -->
            </div>
            <div class="flex justify-between items-center mt-6">
                 <button id="librarySelectAll" class="text-sm text-blue-400 hover:underline">Select All</button>
                <div>
                    <button id="libraryCancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Close</button>
                    <button id="libraryAddBtn" class="bg-primary-color hover:bg-primary-hover text-white font-bold py-2 px-4 rounded-lg">Add Selected</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-md m-4 border border-border-color modal">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                âœ¨ Create with AI
                <span class="group relative">
                    <i class="fas fa-info-circle text-gray-400 text-sm cursor-pointer"></i>
                    <span class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-2 bg-gray-900 text-white text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        This feature requires a valid Gemini API key in the hosting environment.
                    </span>
                </span>
            </h2>
            <p class="text-text-secondary mb-4 text-sm">Enter a theme, and Gemini will generate a new section with sound ideas.</p>
            <form id="aiModalForm">
                <div class="mb-4">
                    <label for="aiTheme" class="block text-sm font-medium text-text-secondary mb-1">Soundboard Theme</label>
                    <input type="text" id="aiTheme" class="w-full bg-gray-900/50 border border-border-color text-text-primary rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-color" placeholder="e.g., Pirate Battle, Sci-Fi..." required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="aiCancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="aiGenerateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center w-28">
                        Generate
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="shareModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-lg m-4 border border-border-color modal">
            <h2 class="text-2xl font-bold mb-4">Share Your Soundboard</h2>
            <p class="text-text-secondary mb-4 text-sm">Copy this link to share your current layout. Anyone with the link will see your soundboard exactly as you've set it up.</p>
            <div class="flex gap-2">
                <input type="text" id="shareLinkInput" readonly class="w-full bg-gray-900/50 border border-border-color text-text-secondary rounded-lg px-3 py-2 focus:outline-none">
                <button id="copyLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
             <div class="flex justify-end mt-6">
                <button id="shareCloseBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-surface-color rounded-xl shadow-lg p-6 w-full max-w-sm m-4 border border-border-color modal">
            <h2 id="confirmModalTitle" class="text-xl font-bold mb-2">Are you sure?</h2>
            <p id="confirmModalText" class="text-text-secondary mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" class="bg-transparent hover:bg-gray-700 text-text-primary font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, delete</button>
            </div>
        </div>
    </div>

    <div id="notification-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element Declarations ---
        const soundboardGrid = document.getElementById('soundboard-grid');
        const searchInput = document.getElementById('searchInput');
        const editModeToggle = document.getElementById('editModeToggle');
        const gridSizeSlider = document.getElementById('gridSizeSlider');
        
        // Modals & Forms
        const modal = document.getElementById('modal');
        const modalForm = document.getElementById('modalForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmModal = document.getElementById('confirmModal');
        const aiModal = document.getElementById('aiModal');
        const aiModalForm = document.getElementById('aiModalForm');
        const aiCancelBtn = document.getElementById('aiCancelBtn');
        const shareModal = document.getElementById('shareModal');
        const libraryModal = document.getElementById('libraryModal');
        const librarySoundList = document.getElementById('library-sound-list');
        
        // Buttons
        const addSectionBtn = document.getElementById('addSectionBtn');
        const libraryBtn = document.getElementById('libraryBtn');
        const aiCreateBtn = document.getElementById('aiCreateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importInput = document.getElementById('importInput');
        const shareBtn = document.getElementById('shareBtn');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const shareCloseBtn = document.getElementById('shareCloseBtn');
        const libraryCancelBtn = document.getElementById('libraryCancelBtn');
        const libraryAddBtn = document.getElementById('libraryAddBtn');
        const librarySelectAll = document.getElementById('librarySelectAll');
        
        // --- State ---
        let audioContext = null;
        let currentAudioSource = null;
        let soundData = [];
        let confirmCallback = null;
        let draggedItem = null;

        const initialData = []; // Start with an empty soundboard

        // --- Core Functions ---
        const loadData = () => {
            try {
                // Prioritize loading from URL hash
                if (window.location.hash && window.location.hash.startsWith('#data=')) {
                    const encodedData = window.location.hash.substring(6);
                    const compressed = atob(encodedData).split('').map(c => c.charCodeAt(0));
                    const decompressed = pako.inflate(new Uint8Array(compressed), { to: 'string' });
                    soundData = JSON.parse(decompressed);
                    showNotification('Loaded soundboard from shared link!', 'info');
                } else {
                    const savedData = localStorage.getItem('soundboardData');
                    soundData = savedData ? JSON.parse(savedData) : initialData;
                }
            } catch (error) {
                console.error("Failed to load data:", error);
                showNotification("Could not load data. Using default.", "error");
                soundData = initialData;
            }
            const savedGridSize = localStorage.getItem('soundboardButtonGridSize') || '8';
            gridSizeSlider.value = savedGridSize;
            renderSoundboard();
        };

        const saveData = () => {
            localStorage.setItem('soundboardData', JSON.stringify(soundData));
            // If the user modifies a shared board, we clear the hash to avoid confusion.
            if (window.location.hash) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
            }
        };
        const saveGridSize = () => localStorage.setItem('soundboardButtonGridSize', gridSizeSlider.value);

        function playSound(url, button = null) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') audioContext.resume();
            if (currentAudioSource) try { currentAudioSource.stop(); } catch (e) {}

            const originalIconHTML = button ? button.innerHTML : null;
            if(button) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner !w-5 !h-5"></div>';
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    source.start(0);
                    currentAudioSource = source;
                    source.onended = () => { 
                        if(button) {
                            button.innerHTML = originalIconHTML; 
                            button.disabled = false;
                        }
                    };
                }).catch(e => {
                    let userMessage = `Error playing sound: ${e.message}`;
                    if (e instanceof TypeError) userMessage = 'Could not play sound. The audio host may be blocking it (CORS policy).';
                    showNotification(userMessage, 'error');
                    console.error('Error with audio playback:', e);
                    if(button) {
                        button.innerHTML = originalIconHTML;
                        button.disabled = false;
                    }
                });
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            toast.className = `notification-toast ${bgColor} text-white font-bold py-2 px-4 rounded-lg shadow-lg`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.transition = 'opacity 0.5s';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- Rendering ---
        
        function renderSoundboard(filteredData = null) {
            const dataToRender = filteredData || soundData;
            soundboardGrid.innerHTML = '';
            document.getElementById('empty-state').style.display = (dataToRender.length === 0 && !filteredData) ? 'block' : 'none';

            dataToRender.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'bg-surface-color rounded-xl p-4 border border-border-color draggable-section';
                sectionEl.dataset.id = section.id;
                sectionEl.style.gridColumn = `span ${section.width || 4}`;

                const buttonGridSize = gridSizeSlider.value;
                const buttonGridCols = { '4': 'grid-cols-4', '5': 'grid-cols-5', '6': 'grid-cols-6', '7': 'grid-cols-7', '8': 'grid-cols-8', '9': 'grid-cols-9', '10': 'grid-cols-10', '11': 'grid-cols-11', '12': 'grid-cols-12' };
                const buttonColClass = buttonGridCols[buttonGridSize] || 'grid-cols-8';

                sectionEl.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-border-color">
                        <h2 class="text-xl font-bold truncate">${section.title}</h2>
                        <div class="edit-controls hidden items-center gap-2 text-text-secondary">
                            <button class="edit-item-btn hover:text-white" data-type="section" data-id="${section.id}" title="Edit Section"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-item-btn hover:text-red-400" data-type="section" data-id="${section.id}" title="Delete Section"><i class="fas fa-trash"></i></button>
                            <span class="drag-handle cursor-move" title="Drag Section"><i class="fas fa-grip-vertical"></i></span>
                        </div>
                    </div>
                    <div class="grid ${buttonColClass} gap-3 sound-container"></div>`;

                const soundContainer = sectionEl.querySelector('.sound-container');
                section.sounds.forEach(sound => soundContainer.appendChild(createSoundButton(sound, section.id)));
                
                // Add the "Add Sound" button in edit mode
                const addSoundBtn = document.createElement('button');
                addSoundBtn.className = 'add-sound-btn hidden aspect-square border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-gray-500 hover:bg-gray-700 hover:text-white transition';
                addSoundBtn.dataset.sectionId = section.id;
                addSoundBtn.innerHTML = '<i class="fas fa-plus fa-2x"></i>';
                soundContainer.appendChild(addSoundBtn);

                soundboardGrid.appendChild(sectionEl);
            });
            updateEditMode();
        }

        function createSoundButton(sound, sectionId) {
            const soundBtn = document.createElement('button');
            soundBtn.className = 'sound-btn text-white font-semibold py-3 px-2 rounded-lg flex flex-col items-center justify-center text-center aspect-square draggable';
            soundBtn.dataset.url = sound.url;
            soundBtn.dataset.id = sound.id;
            soundBtn.dataset.sectionId = sectionId;
            soundBtn.style.backgroundColor = sound.color || 'var(--surface-color)';

            soundBtn.innerHTML = `
                <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity edit-overlay hidden items-center justify-center gap-3 text-white">
                    <span class="edit-item-btn cursor-pointer p-2 rounded-full hover:bg-white/20" data-type="sound" data-id="${sound.id}" data-section-id="${sectionId}" title="Edit Sound"><i class="fas fa-pencil-alt"></i></span>
                    <span class="delete-item-btn cursor-pointer p-2 rounded-full hover:bg-white/20" data-type="sound" data-id="${sound.id}" data-section-id="${sectionId}" title="Delete Sound"><i class="fas fa-trash"></i></span>
                </div>
                <div class="flex flex-col items-center justify-center gap-2 pointer-events-none">
                    <i class="fas fa-music text-2xl text-white/60"></i>
                    <span class="text-sm break-words leading-tight">${sound.name}</span>
                </div>`;
            return soundBtn;
        }

        // --- Event Handlers ---
        soundboardGrid.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button, span');
            if (!targetButton) return;

            const isEditMode = document.body.classList.contains('edit-mode');
            if (isEditMode) {
                if (targetButton.classList.contains('add-sound-btn')) {
                    openModal('sound', 'add', { sectionId: targetButton.dataset.sectionId });
                } else if (targetButton.classList.contains('edit-item-btn')) {
                    openModal(targetButton.dataset.type, 'edit', targetButton.dataset);
                } else if (targetButton.classList.contains('delete-item-btn')) {
                    const { type, id, sectionId } = targetButton.dataset;
                    openConfirmModal(`this ${type}`, () => deleteItem(type, id, sectionId));
                }
            } else {
                const soundBtn = e.target.closest('.sound-btn');
                if (soundBtn) playSound(soundBtn.dataset.url, soundBtn.querySelector('.fa-music'));
            }
        });
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) { renderSoundboard(); return; }
            
            const filteredData = JSON.parse(JSON.stringify(soundData))
                .map(section => {
                    section.sounds = section.sounds.filter(sound => sound.name.toLowerCase().includes(searchTerm));
                    return section;
                }).filter(section => section.sounds.length > 0);
            renderSoundboard(filteredData);
        });

        editModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('edit-mode');
            updateEditMode();
        });
        
        function updateEditMode() {
            const isEditMode = document.body.classList.contains('edit-mode');
            document.getElementById('edit-actions').style.display = isEditMode ? 'flex' : 'none';
            document.body.classList.toggle('edit-mode-active', isEditMode); // Use a class for CSS targeting
            document.querySelectorAll('.draggable, .draggable-section').forEach(el => el.setAttribute('draggable', isEditMode));
            document.querySelectorAll('.add-sound-btn').forEach(btn => btn.style.display = isEditMode ? 'flex' : 'none');
            document.querySelectorAll('.edit-controls').forEach(el => el.style.display = isEditMode ? 'flex' : 'none');
        }
        
        gridSizeSlider.addEventListener('input', () => renderSoundboard());
        gridSizeSlider.addEventListener('change', () => saveGridSize());

        // --- Modal Logic ---
        function openModal(type, mode, data) {
            modalForm.reset();
            const { id = '', sectionId = '' } = data;
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editSectionId').value = sectionId;

            ['form-group-url', 'form-group-color', 'form-group-width'].forEach(id => document.getElementById(id).style.display = 'none');

            if (type === 'section') {
                document.getElementById('form-group-width').style.display = 'block';
                document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Section' : 'Edit Section';
                if (mode === 'edit') {
                    const section = soundData.find(s => s.id === id);
                    document.getElementById('itemName').value = section.title;
                    document.getElementById('itemWidth').value = section.width || 4;
                } else {
                    document.getElementById('itemWidth').value = 4;
                }
            } else { // 'sound'
                ['form-group-url', 'form-group-color'].forEach(id => document.getElementById(id).style.display = 'block');
                document.getElementById('modalTitle').textContent = mode === 'add' ? 'Add New Sound' : 'Edit Sound';
                 if (mode === 'edit') {
                    const section = soundData.find(s => s.id === sectionId);
                    const sound = section.sounds.find(snd => snd.id === id);
                    document.getElementById('itemName').value = sound.name;
                    document.getElementById('itemUrl').value = sound.url;
                    document.getElementById('itemColor').value = sound.color || '#1f2937';
                } else {
                    document.getElementById('itemColor').value = '#1f2937';
                }
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            aiModal.classList.add('hidden');
            confirmModal.classList.add('hidden');
            shareModal.classList.add('hidden');
            libraryModal.classList.add('hidden');
        }

        modalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('itemName');
            const urlInput = document.getElementById('itemUrl');
            const type = document.getElementById('editType').value;

            if (!nameInput.value.trim()) { showNotification('Name is required.', 'error'); return; }
            if (type === 'sound') {
                try { new URL(urlInput.value); } catch (_) { showNotification('Please enter a valid URL.', 'error'); return; }
            }
            
            const id = document.getElementById('editId').value;
            const sectionId = document.getElementById('editSectionId').value;
            const name = nameInput.value;

            if (type === 'section') {
                const width = document.getElementById('itemWidth').value;
                if (id) {
                    const section = soundData.find(s => s.id === id);
                    if(section) { section.title = name; section.width = width; }
                } else {
                    soundData.push({ id: `section-${Date.now()}`, title: name, width: width, sounds: [] });
                }
            } else {
                const url = urlInput.value;
                const color = document.getElementById('itemColor').value;
                const section = soundData.find(s => s.id === sectionId);
                if (!section) { showNotification('Error: Section not found!', 'error'); return; }

                if (id) {
                    const sound = section.sounds.find(snd => snd.id === id);
                    if (sound) { sound.name = name; sound.url = url; sound.color = color; }
                } else {
                    section.sounds.push({ id: `sound-${Date.now()}`, name, url, color });
                }
            }
            saveData();
            renderSoundboard();
            closeModal();
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} saved successfully!`);
        });

        [cancelBtn, aiCancelBtn, shareCloseBtn, libraryCancelBtn].forEach(btn => btn.addEventListener('click', closeModal));
        addSectionBtn.addEventListener('click', () => openModal('section', 'add', {}));

        // --- AI Modal & Gemini API ---
        aiCreateBtn.addEventListener('click', () => aiModal.classList.remove('hidden'));
        
        aiModalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const theme = document.getElementById('aiTheme').value.trim();
            if (!theme) { showNotification('Please enter a theme.', 'error'); return; }
            
            const generateBtn = e.submitter;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="spinner"></div>';

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = `You are a creative assistant for a soundboard app. Generate a list of 5 to 8 sound effect names based on a user's theme. Respond ONLY with a valid JSON array of strings. Do not include any other text, explanations, or markdown formatting. Example response for theme "Pirate Ship": ["Cannon Fire", "Sea Shanty", "Parrot Squawk", "Sword Fight", "Waves Crashing"]`;
            const payload = {
                contents: [{ parts: [{ text: `Theme: "${theme}"` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "STRING" } } }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const soundNamesText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!soundNamesText) throw new Error("Received an empty response from the AI.");

                const soundNames = JSON.parse(soundNamesText);
                const newSection = {
                    id: `section-${Date.now()}`, title: theme, width: 4,
                    sounds: soundNames.map((name, index) => ({
                        id: `sound-${Date.now() + index}`, name: name,
                        url: 'https://www.soundjay.com/buttons/sounds/button-20.mp3',
                        color: '#1f2937'
                    }))
                };
                soundData.push(newSection);
                saveData();
                renderSoundboard();
                closeModal();
                showNotification(`AI created the "${theme}" section!`, 'info');
            } catch (error) {
                console.error("Gemini API Error:", error);
                let errorMessage = "AI failed to generate ideas. Please try again.";
                if (error.message.includes("403")) errorMessage = "AI generation failed (403 Forbidden). This may be an API key issue.";
                showNotification(errorMessage, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate';
            }
        });
        
        // --- Confirmation Modal ---
        function openConfirmModal(actionText, onConfirm) {
            document.getElementById('confirmModalText').textContent = `Are you sure you want to delete ${actionText}?`;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeModal();
        });
        document.getElementById('confirmCancelBtn').addEventListener('click', closeModal);

        // --- CRUD operations ---
        function deleteItem(type, id, sectionId) {
            if (type === 'section') {
                soundData = soundData.filter(s => s.id !== id);
            } else {
                const section = soundData.find(s => s.id === sectionId);
                if (section) section.sounds = section.sounds.filter(snd => snd.id !== id);
            }
            saveData();
            renderSoundboard();
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted.`, 'info');
        }
        
        // --- Drag and Drop ---
        soundboardGrid.addEventListener('dragstart', (e) => {
            if (!document.body.classList.contains('edit-mode-active')) { e.preventDefault(); return; }
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });

        soundboardGrid.addEventListener('dragend', () => {
            draggedItem?.classList.remove('dragging');
            draggedItem = null;
        });

        soundboardGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!draggedItem) return;
            const target = e.target.closest('.draggable, .draggable-section, .sound-container');
            if (target) {
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                if (!target.classList.contains('sound-container')) {
                    target.classList.add('drag-over');
                }
            }
        });

        soundboardGrid.addEventListener('dragleave', e => e.target.closest('.drag-over')?.classList.remove('drag-over'));

        soundboardGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if (!draggedItem) return;

            const isSectionDrag = draggedItem.classList.contains('draggable-section');
            const target = e.target.closest(isSectionDrag ? '.draggable-section' : '.draggable, .sound-container');
            if (!target || target === draggedItem) return;
            
            if (isSectionDrag) {
                const fromIndex = soundData.findIndex(s => s.id === draggedItem.dataset.id);
                const toIndex = soundData.findIndex(s => s.id === target.dataset.id);
                const [moved] = soundData.splice(fromIndex, 1);
                soundData.splice(toIndex, 0, moved);
            } else { // Sound drag
                const fromSection = soundData.find(s => s.id === draggedItem.dataset.sectionId);
                const fromSoundIndex = fromSection.sounds.findIndex(s => s.id === draggedItem.dataset.id);
                
                const targetSoundContainer = target.closest('.sound-container');
                const toSection = soundData.find(s => s.id === targetSoundContainer.closest('.draggable-section').dataset.id);
                const toSoundEl = target.closest('.draggable');
                let toSoundIndex = toSoundEl ? toSection.sounds.findIndex(s => s.id === toSoundEl.dataset.id) : toSection.sounds.length;
                
                const [movedSound] = fromSection.sounds.splice(fromSoundIndex, 1);
                toSection.sounds.splice(toSoundIndex, 0, movedSound);
            }
            saveData();
            renderSoundboard();
        });
        
        // --- Import / Export / Share ---
        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify(soundData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my-soundboard-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (Array.isArray(importedData)) {
                        openConfirmModal('your current soundboard by importing a new one', () => {
                            soundData = importedData;
                            saveData();
                            renderSoundboard();
                            showNotification('Soundboard imported successfully!');
                        });
                    } else { showNotification('Invalid soundboard file format.', 'error'); }
                } catch (error) { showNotification('Error parsing JSON file.', 'error'); }
                 finally { importInput.value = ''; }
            };
            reader.readAsText(file);
        });
        
        shareBtn.addEventListener('click', () => {
            const jsonString = JSON.stringify(soundData);
            const compressed = pako.deflate(jsonString);
            const encodedData = btoa(String.fromCharCode.apply(null, compressed));
            const shareLink = `${window.location.origin}${window.location.pathname}#data=${encodedData}`;
            
            const shareLinkInput = document.getElementById('shareLinkInput');
            shareLinkInput.value = shareLink;
            shareModal.classList.remove('hidden');
            shareLinkInput.select();
        });

        copyLinkBtn.addEventListener('click', () => {
            const shareLinkInput = document.getElementById('shareLinkInput');
            shareLinkInput.select();
            // Use execCommand for broader compatibility in sandboxed environments
            try {
                document.execCommand('copy');
                showNotification('Link copied to clipboard!', 'info');
            } catch (err) {
                showNotification('Failed to copy link.', 'error');
                console.error('Copy failed', err);
            }
        });

        // --- Sound Library Logic ---
        libraryBtn.addEventListener('click', async () => {
            libraryModal.classList.remove('hidden');
            librarySoundList.innerHTML = '<div class="flex justify-center items-center p-8"><div class="spinner !w-8 !h-8"></div></div>';
            
            try {
                const response = await fetch('https://api.github.com/repos/MrLynchWAMS/soundboard/contents/sounds');
                if (!response.ok) throw new Error('Failed to fetch from GitHub');
                const files = await response.json();
                
                librarySoundList.innerHTML = '';
                const audioFiles = files.filter(file => /\.(mp3|wav|ogg)$/i.test(file.name));

                if (audioFiles.length === 0) {
                    librarySoundList.innerHTML = '<p class="text-center text-gray-500 p-4">No audio files found in the GitHub repository.</p>';
                    return;
                }

                audioFiles.forEach(file => {
                    const soundEl = document.createElement('div');
                    soundEl.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-700';
                    soundEl.innerHTML = `
                        <label class="flex items-center gap-3 cursor-pointer w-full">
                            <input type="checkbox" data-name="${file.name}" data-url="${file.download_url}" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 rounded text-blue-500 focus:ring-blue-500">
                            <span class="truncate">${file.name}</span>
                        </label>
                        <button class="preview-lib-sound-btn p-2 text-gray-400 hover:text-white" data-url="${file.download_url}">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                    librarySoundList.appendChild(soundEl);
                });
            } catch (error) {
                console.error("Error fetching sound library:", error);
                librarySoundList.innerHTML = '<p class="text-center text-red-400 p-4">Could not load library. Check console for details.</p>';
            }
        });

        librarySoundList.addEventListener('click', e => {
            const previewBtn = e.target.closest('.preview-lib-sound-btn');
            if (previewBtn) {
                playSound(previewBtn.dataset.url, previewBtn);
            }
        });
        
        librarySelectAll.addEventListener('click', () => {
            const checkboxes = librarySoundList.querySelectorAll('input[type="checkbox"]');
            const isAllChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !isAllChecked);
            librarySelectAll.textContent = isAllChecked ? 'Select All' : 'Deselect All';
        });

        libraryAddBtn.addEventListener('click', () => {
            const selectedSounds = Array.from(librarySoundList.querySelectorAll('input[type="checkbox"]:checked'));
            if (selectedSounds.length === 0) {
                showNotification('No sounds selected.', 'error');
                return;
            }

            const newSection = {
                id: `section-${Date.now()}`,
                title: 'From Library',
                width: 4,
                sounds: selectedSounds.map((input, i) => ({
                    id: `sound-${Date.now() + i}`,
                    name: input.dataset.name.replace(/\.[^/.]+$/, ""), // Remove file extension for name
                    url: input.dataset.url,
                    color: '#1f2937'
                }))
            };

            soundData.push(newSection);
            saveData();
            renderSoundboard();
            closeModal();
            showNotification(`Added ${selectedSounds.length} sounds.`, 'info');
        });


        // --- Initialize ---
        loadData();
    });
    </script>
</body>
</html>

